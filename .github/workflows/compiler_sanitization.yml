name: Compiler Sanitizer Tests

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  clang_ASAN_UBSAN:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-tags: true

      - name: Install system dependencies
        run: |
          brew install mpfr fftw cmake

      - name: Set up LLVM
        run: |
          brew install llvm@19
          LLVM_PREFIX=$(brew --prefix llvm@19)
          echo "CC=$LLVM_PREFIX/bin/clang" >> $GITHUB_ENV
          echo "CXX=$LLVM_PREFIX/bin/clang++" >> $GITHUB_ENV
          echo "LDFLAGS=-L$LLVM_PREFIX/lib" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$LLVM_PREFIX/include" >> $GITHUB_ENV

      - name: Set up pyenv
        run: |
          git clone https://github.com/pyenv/pyenv.git "$HOME/.pyenv"
          PYENV_ROOT="$HOME/.pyenv"
          PYENV_BIN="$PYENV_ROOT/bin"
          PYENV_SHIMS="$PYENV_ROOT/shims"
          echo "$PYENV_BIN" >> $GITHUB_PATH
          echo "$PYENV_SHIMS" >> $GITHUB_PATH
          echo "PYENV_ROOT=$PYENV_ROOT" >> $GITHUB_ENV

      - name: Check pyenv is working
        run: pyenv --version

      - name: Build CPython with address sanitizer
        run: |
          CONFIGURE_OPTS="--with-address-sanitizer" pyenv install 3.14t
          pyenv global 3.14t

      - name: Install Python build dependencies
        run: |
          pip install meson meson-python ninja cython pytest hypothesis wheel build patchelf pytest-timeout

      - name: Clone and build NumPy with ASan
        run: |
          git clone --depth 1 https://github.com/numpy/numpy.git numpy-asan
          cd numpy-asan
          git submodule update --init --recursive
          # Build NumPy with address sanitizer using pip
          pip install . -v --no-build-isolation \
            -Csetup-args=-Db_sanitize=address,undefined \
            -Csetup-args=-Db_lundef=false

      - name: Build and install quaddtype with ASan
        working-directory: quaddtype
        run: |
          # Build with sanitizers - these flags propagate to subprojects (SLEEF, qblas) by default
          pip install .[test] -v --no-build-isolation \
            -Csetup-args=-Db_sanitize=address,undefined \
            -Csetup-args=-Db_lundef=false

      - name: Create sanitizer suppression files
        run: |
          # Create ASAN suppression file for external libraries
          # Format: interceptor_via_lib:LibraryName or interceptor_via_fun:FunctionName
          # This suppresses issues in external libraries (not recompiled with ASan instrumentation)
          cat > ${{ github.workspace }}/asan_suppressions.txt << 'EOF'
          interceptor_via_lib:libpython
          interceptor_via_lib:_multiarray_umath
          interceptor_via_lib:numpy
          EOF
          sed -i '' 's/^[[:space:]]*//' ${{ github.workspace }}/asan_suppressions.txt

          # Create LSAN suppression file (for leak sanitizer, part of ASAN)
          cat > ${{ github.workspace }}/lsan_suppressions.txt << 'EOF'
          leak:*numpy*
          leak:*_multiarray*
          leak:*_umath*
          leak:*cpython*
          leak:*python*
          leak:*PyObject*
          EOF
          sed -i '' 's/^[[:space:]]*//' ${{ github.workspace }}/lsan_suppressions.txt

          # Create UBSAN suppression file to ignore NumPy issues
          # Format: <check-type>:<file-or-function-pattern>
          cat > ${{ github.workspace }}/ubsan_suppressions.txt << 'EOF'
          signed-integer-overflow:*numpy*
          signed-integer-overflow:*_multiarray*
          signed-integer-overflow:*_umath*
          shift-base:*numpy*
          shift-exponent:*numpy*
          alignment:*numpy*
          signed-integer-overflow:*python*
          signed-integer-overflow:*cpython*
          vptr:*python*
          EOF
          sed -i '' 's/^[[:space:]]*//' ${{ github.workspace }}/ubsan_suppressions.txt

      - name: Run quaddtype tests with ASan
        working-directory: quaddtype
        run: |
          # Run tests with sanitizer suppressions - only quaddtype issues will be reported
          # - ASAN: Suppress issues from NumPy/Python external libraries
          # - LSAN: Suppress leaks from NumPy/Python internals (disabled via detect_leaks=0)
          # - UBSAN: Suppress UB issues from NumPy/Python, halt on quaddtype issues
          ASAN_OPTIONS=detect_leaks=0:symbolize=1:strict_init_order=true:allocator_may_return_null=1:suppressions=${{ github.workspace }}/asan_suppressions.txt:print_suppressions=0 \
          LSAN_OPTIONS=suppressions=${{ github.workspace }}/lsan_suppressions.txt:print_suppressions=0 \
          UBSAN_OPTIONS=halt_on_error=1:print_stacktrace=1:suppressions=${{ github.workspace }}/ubsan_suppressions.txt:print_suppressions=0 \
          pytest -vvv --color=yes --timeout=600 --durations=10
